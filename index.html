<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³´ì•ˆ ì±„íŒ…</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .bg-shape {
            position: absolute;
            opacity: 0.08;
            pointer-events: none;
        }
        .circle1 {
            width: 500px;
            height: 500px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            top: -250px;
            left: -200px;
        }
        .circle2 {
            width: 350px;
            height: 350px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            bottom: -150px;
            right: -100px;
        }
        .square1 {
            width: 250px;
            height: 250px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            transform: rotate(45deg);
            top: 8%;
            right: 12%;
        }
        .square2 {
            width: 180px;
            height: 180px;
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            transform: rotate(25deg);
            bottom: 20%;
            left: 10%;
        }
        .triangle {
            width: 0;
            height: 0;
            border-left: 120px solid transparent;
            border-right: 120px solid transparent;
            border-bottom: 200px solid #a18cd1;
            top: 45%;
            left: 3%;
            transform: rotate(15deg);
        }
        
        #root {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="bg-shape circle1"></div>
    <div class="bg-shape circle2"></div>
    <div class="bg-shape square1"></div>
    <div class="bg-shape square2"></div>
    <div class="bg-shape triangle"></div>
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==================== Storage ë˜í¼ (localStorage ì‚¬ìš©) ====================
        
        const Storage = {
            get(key) {
                try {
                    const value = localStorage.getItem(key);
                    return value;
                } catch (error) {
                    console.error('Storage get error:', error);
                    return null;
                }
            },
            
            set(key, value) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (error) {
                    console.error('Storage set error:', error);
                    return false;
                }
            },
            
            delete(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('Storage delete error:', error);
                    return false;
                }
            },
            
            list(prefix = '') {
                try {
                    const keys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith(prefix)) {
                            keys.push(key);
                        }
                    }
                    return keys;
                } catch (error) {
                    console.error('Storage list error:', error);
                    return [];
                }
            }
        };

        // ==================== ë³´ì•ˆ ìœ í‹¸ë¦¬í‹° ====================
        
        // ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜
        async function hashPassword(password, salt = '') {
            const text = salt + password + 'SECRET_SALT_2024';
            const msgBuffer = new TextEncoder().encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // XSS ë°©ì§€ë¥¼ ìœ„í•œ HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;',
                '/': '&#x2F;'
            };
            return String(text).replace(/[&<>"'/]/g, (s) => map[s]);
        }

        // ì…ë ¥ ê²€ì¦ í•¨ìˆ˜
        function validateUsername(username) {
            if (!username || typeof username !== 'string') {
                return { valid: false, error: 'ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' };
            }
            const trimmed = username.trim();
            if (trimmed.length < 3 || trimmed.length > 20) {
                return { valid: false, error: 'ì•„ì´ë””ëŠ” 3-20ìì—¬ì•¼ í•©ë‹ˆë‹¤.' };
            }
            if (!/^[a-zA-Z0-9ê°€-í£_]+$/.test(trimmed)) {
                return { valid: false, error: 'ì•„ì´ë””ëŠ” ì˜ë¬¸, ìˆ«ì, í•œê¸€, _ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.' };
            }
            return { valid: true, value: trimmed };
        }

        function validatePassword(password) {
            if (!password || typeof password !== 'string') {
                return { valid: false, error: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' };
            }
            if (password.length < 6 || password.length > 50) {
                return { valid: false, error: 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6-50ìì—¬ì•¼ í•©ë‹ˆë‹¤.' };
            }
            if (!/[a-zA-Z]/.test(password) || !/[0-9]/.test(password)) {
                return { valid: false, error: 'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸ê³¼ ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.' };
            }
            return { valid: true, value: password };
        }

        // ìš•ì„¤ í•„í„°
        const profanityList = [
            'ì‹œë°œ', 'ì”¨ë°œ', 'ê°œìƒˆ', 'ë³‘ì‹ ', 'ì§€ë„', 'ì¢†', 'ì”¹', 
            'ë¯¸ì¹œ', 'ë˜ë¼ì´', 'ì—¼ë³‘', 'ì—¿', 'ê°œìì‹', 'ìƒˆë¼', 'ë…„', 
            'ì“°ë ˆê¸°', 'ì¡´ë‚˜', 'fuck', 'shit', 'bitch', 'ass',
            'êº¼ì ¸', 'ì£½ì–´', 'ë©ì²­', 'ë°”ë³´', 'ë“±ì‹ ', 'ë†ˆ',
            'ì• ë¯¸', 'ì• ë¹„', 'ì°½ë…€', 'ì…', 'ëŠê¸ˆ'
        ];

        function filterProfanity(text) {
            let filtered = escapeHtml(text);
            profanityList.forEach(word => {
                const regex = new RegExp(word, 'gi');
                filtered = filtered.replace(regex, (match) => '*'.repeat(match.length));
            });
            return filtered;
        }

        // ==================== ë¡œê·¸ì¸/íšŒì›ê°€ì… ì»´í¬ë„ŒíŠ¸ ====================
        
        function AuthScreen({ onLogin }) {
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                setLoading(true);

                try {
                    // 1. ì…ë ¥ ê²€ì¦
                    const usernameValidation = validateUsername(username);
                    if (!usernameValidation.valid) {
                        setError(usernameValidation.error);
                        setLoading(false);
                        return;
                    }

                    const passwordValidation = validatePassword(password);
                    if (!passwordValidation.valid) {
                        setError(passwordValidation.error);
                        setLoading(false);
                        return;
                    }

                    const cleanUsername = usernameValidation.value;
                    const cleanPassword = passwordValidation.value;

                    if (isLogin) {
                        // ===== ë¡œê·¸ì¸ =====
                        const userDataStr = Storage.get(`user:${cleanUsername}`);
                        
                        if (!userDataStr) {
                            setError('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
                            setLoading(false);
                            return;
                        }

                        const userData = JSON.parse(userDataStr);
                        const hashedPassword = await hashPassword(cleanPassword, userData.salt);

                        if (userData.password !== hashedPassword) {
                            setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                            setLoading(false);
                            return;
                        }

                        // ë¡œê·¸ì¸ ì„±ê³µ
                        setSuccess('ë¡œê·¸ì¸ ì„±ê³µ!');
                        setTimeout(() => onLogin(cleanUsername), 300);
                        
                    } else {
                        // ===== íšŒì›ê°€ì… =====
                        
                        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                        if (cleanPassword !== confirmPassword) {
                            setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                            setLoading(false);
                            return;
                        }

                        // ì¤‘ë³µ í™•ì¸
                        const existingUser = Storage.get(`user:${cleanUsername}`);
                        if (existingUser) {
                            setError('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
                            setLoading(false);
                            return;
                        }

                        // Salt ìƒì„±
                        const salt = Math.random().toString(36).substring(2, 15) + 
                                    Math.random().toString(36).substring(2, 15);
                        const hashedPassword = await hashPassword(cleanPassword, salt);

                        const userData = {
                            username: cleanUsername,
                            password: hashedPassword,
                            salt: salt,
                            createdAt: new Date().toISOString()
                        };

                        // ì €ì¥
                        const saveResult = Storage.set(`user:${cleanUsername}`, JSON.stringify(userData));

                        if (!saveResult) {
                            setError('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                            setLoading(false);
                            return;
                        }

                        // ì €ì¥ í™•ì¸
                        const verifyResult = Storage.get(`user:${cleanUsername}`);
                        if (!verifyResult) {
                            setError('íšŒì›ê°€ì… ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                            setLoading(false);
                            return;
                        }

                        // íšŒì›ê°€ì… ì„±ê³µ
                        setSuccess('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        setTimeout(() => {
                            setIsLogin(true);
                            setPassword('');
                            setConfirmPassword('');
                            setSuccess('');
                        }, 1500);
                    }
                } catch (error) {
                    console.error('ì¸ì¦ ì˜¤ë¥˜:', error);
                    setError(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fade-in" style={{
                    background: 'white',
                    borderRadius: '20px',
                    padding: '50px',
                    boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
                    maxWidth: '450px',
                    margin: '0 auto',
                    border: '1px solid #e8e8e8'
                }}>
                    <div style={{ textAlign: 'center', marginBottom: '35px' }}>
                        <div style={{
                            fontSize: '48px',
                            marginBottom: '10px'
                        }}>ğŸ’¬</div>
                        <h1 style={{
                            color: '#1a1a2e',
                            marginBottom: '8px',
                            fontSize: '32px',
                            fontWeight: '700'
                        }}>
                            ë³´ì•ˆ ì±„íŒ…
                        </h1>
                        <p style={{
                            color: '#666',
                            fontSize: '14px'
                        }}>
                            {isLogin ? 'ê³„ì •ì— ë¡œê·¸ì¸í•˜ì„¸ìš”' : 'ìƒˆ ê³„ì •ì„ ë§Œë“œì„¸ìš”'}
                        </p>
                    </div>

                    <div style={{
                        display: 'flex',
                        marginBottom: '30px',
                        borderRadius: '12px',
                        overflow: 'hidden',
                        background: '#f5f5f5',
                        padding: '4px',
                        border: '1px solid #e0e0e0'
                    }}>
                        <button
                            type="button"
                            onClick={() => {
                                setIsLogin(true);
                                setError('');
                                setSuccess('');
                            }}
                            style={{
                                flex: 1,
                                padding: '14px',
                                border: 'none',
                                background: isLogin ? 'white' : 'transparent',
                                color: isLogin ? '#1a1a2e' : '#888',
                                fontSize: '15px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                borderRadius: '8px',
                                boxShadow: isLogin ? '0 2px 8px rgba(0,0,0,0.08)' : 'none'
                            }}
                        >
                            ë¡œê·¸ì¸
                        </button>
                        <button
                            type="button"
                            onClick={() => {
                                setIsLogin(false);
                                setError('');
                                setSuccess('');
                            }}
                            style={{
                                flex: 1,
                                padding: '14px',
                                border: 'none',
                                background: !isLogin ? 'white' : 'transparent',
                                color: !isLogin ? '#1a1a2e' : '#888',
                                fontSize: '15px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                borderRadius: '8px',
                                boxShadow: !isLogin ? '0 2px 8px rgba(0,0,0,0.08)' : 'none'
                            }}
                        >
                            íšŒì›ê°€ì…
                        </button>
                    </div>

                    <form onSubmit={handleSubmit}>
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{
                                display: 'block',
                                marginBottom: '8px',
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#333'
                            }}>
                                ì•„ì´ë””
                            </label>
                            <input
                                type="text"
                                placeholder="3-20ì (ì˜ë¬¸, ìˆ«ì, í•œê¸€, _ ê°€ëŠ¥)"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                disabled={loading}
                                autoComplete="username"
                                style={{
                                    width: '100%',
                                    padding: '14px 16px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    fontSize: '15px',
                                    outline: 'none',
                                    transition: 'all 0.2s',
                                    background: loading ? '#f5f5f5' : 'white'
                                }}
                                onFocus={(e) => e.target.style.borderColor = '#667eea'}
                                onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                            />
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={{
                                display: 'block',
                                marginBottom: '8px',
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#333'
                            }}>
                                ë¹„ë°€ë²ˆí˜¸
                            </label>
                            <input
                                type="password"
                                placeholder="6ì ì´ìƒ (ì˜ë¬¸+ìˆ«ì í¬í•¨)"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                disabled={loading}
                                autoComplete={isLogin ? "current-password" : "new-password"}
                                style={{
                                    width: '100%',
                                    padding: '14px 16px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    fontSize: '15px',
                                    outline: 'none',
                                    transition: 'all 0.2s',
                                    background: loading ? '#f5f5f5' : 'white'
                                }}
                                onFocus={(e) => e.target.style.borderColor = '#667eea'}
                                onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                            />
                        </div>

                        {!isLogin && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{
                                    display: 'block',
                                    marginBottom: '8px',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    color: '#333'
                                }}>
                                    ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                                </label>
                                <input
                                    type="password"
                                    placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    disabled={loading}
                                    autoComplete="new-password"
                                    style={{
                                        width: '100%',
                                        padding: '14px 16px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '10px',
                                        fontSize: '15px',
                                        outline: 'none',
                                        transition: 'all 0.2s',
                                        background: loading ? '#f5f5f5' : 'white'
                                    }}
                                    onFocus={(e) => e.target.style.borderColor = '#667eea'}
                                    onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                                />
                            </div>
                        )}

                        {error && (
                            <div style={{
                                background: '#fff5f5',
                                color: '#c53030',
                                padding: '14px',
                                borderRadius: '10px',
                                marginBottom: '20px',
                                fontSize: '14px',
                                border: '1px solid #feb2b2',
                                fontWeight: '500'
                            }}>
                                âš ï¸ {error}
                            </div>
                        )}

                        {success && (
                            <div style={{
                                background: '#f0fdf4',
                                color: '#15803d',
                                padding: '14px',
                                borderRadius: '10px',
                                marginBottom: '20px',
                                fontSize: '14px',
                                border: '1px solid #86efac',
                                fontWeight: '500'
                            }}>
                                âœ… {success}
                            </div>
                        )}

                        <button
                            type="submit"
                            disabled={loading}
                            style={{
                                width: '100%',
                                padding: '16px',
                                background: loading ? '#cbd5e0' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                fontSize: '16px',
                                fontWeight: '700',
                                cursor: loading ? 'not-allowed' : 'pointer',
                                transition: 'all 0.2s',
                                boxShadow: loading ? 'none' : '0 4px 15px rgba(102, 126, 234, 0.4)'
                            }}
                            onMouseEnter={(e) => {
                                if (!loading) e.target.style.transform = 'translateY(-2px)';
                            }}
                            onMouseLeave={(e) => {
                                if (!loading) e.target.style.transform = 'translateY(0)';
                            }}
                        >
                            {loading ? 'ì²˜ë¦¬ì¤‘...' : (isLogin ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…')}
                        </button>

                        {!isLogin && (
                            <div style={{
                                marginTop: '20px',
                                padding: '12px',
                                background: '#f7fafc',
                                borderRadius: '8px',
                                fontSize: '12px',
                                color: '#4a5568',
                                lineHeight: '1.6'
                            }}>
                                <strong>ğŸ”’ ë³´ì•ˆ ì •ì±…:</strong><br/>
                                â€¢ ë¹„ë°€ë²ˆí˜¸ëŠ” SHA-256ìœ¼ë¡œ í•´ì‹œí™”ë©ë‹ˆë‹¤<br/>
                                â€¢ XSS ê³µê²© ë°©ì§€ í•„í„° ì ìš©<br/>
                                â€¢ ì…ë ¥ê°’ ê²€ì¦ ë° ìƒˆë‹ˆíƒ€ì´ì§•<br/>
                                â€¢ ìš•ì„¤ í•„í„° ìë™ ì ìš©
                            </div>
                        )}
                    </form>
                </div>
            );
        }

        // ==================== ì±„íŒ… ì»´í¬ë„ŒíŠ¸ ====================
        
        function ChatScreen({ username, onLogout }) {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [onlineUsers, setOnlineUsers] = useState(new Set());
            const [sendingMessage, setSendingMessage] = useState(false);
            const messagesEndRef = useRef(null);
            const messageLoadInterval = useRef(null);
            const onlineUpdateInterval = useRef(null);

            useEffect(() => {
                loadMessages();
                messageLoadInterval.current = setInterval(loadMessages, 1000);
                return () => {
                    if (messageLoadInterval.current) {
                        clearInterval(messageLoadInterval.current);
                    }
                };
            }, []);

            useEffect(() => {
                updateOnlineStatus();
                onlineUpdateInterval.current = setInterval(updateOnlineStatus, 3000);
                return () => {
                    if (onlineUpdateInterval.current) {
                        clearInterval(onlineUpdateInterval.current);
                    }
                };
            }, [username]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const loadMessages = () => {
                const messagesStr = Storage.get('chat:messages');
                if (messagesStr) {
                    try {
                        const msgs = JSON.parse(messagesStr);
                        if (Array.isArray(msgs)) {
                            setMessages(msgs);
                        }
                    } catch (error) {
                        console.error('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', error);
                    }
                }
            };

            const updateOnlineStatus = () => {
                const now = Date.now();
                Storage.set(`online:${username}`, now.toString());

                const keys = Storage.list('online:');
                const users = new Set();
                
                keys.forEach(key => {
                    const lastSeenStr = Storage.get(key);
                    if (lastSeenStr) {
                        const lastSeen = parseInt(lastSeenStr);
                        if (now - lastSeen < 10000) { // 10ì´ˆ ì´ë‚´
                            const user = key.replace('online:', '');
                            users.add(user);
                        }
                    }
                });
                
                setOnlineUsers(users);
            };

            const sendMessage = async (e) => {
                e.preventDefault();
                
                const trimmedMessage = inputMessage.trim();
                if (!trimmedMessage || sendingMessage) return;

                if (trimmedMessage.length > 500) {
                    alert('ë©”ì‹œì§€ëŠ” 500ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                setSendingMessage(true);

                try {
                    const filteredMessage = filterProfanity(trimmedMessage);
                    const isFiltered = filteredMessage !== escapeHtml(trimmedMessage);
                    
                    const newMessage = {
                        id: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        username: escapeHtml(username),
                        text: filteredMessage,
                        timestamp: new Date().toISOString(),
                        isFiltered: isFiltered
                    };

                    // í˜„ì¬ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
                    let currentMessages = [];
                    const messagesStr = Storage.get('chat:messages');
                    if (messagesStr) {
                        try {
                            currentMessages = JSON.parse(messagesStr);
                            if (!Array.isArray(currentMessages)) {
                                currentMessages = [];
                            }
                        } catch (error) {
                            currentMessages = [];
                        }
                    }

                    const updatedMessages = [...currentMessages, newMessage];
                    
                    // ìµœê·¼ 100ê°œë§Œ ìœ ì§€
                    if (updatedMessages.length > 100) {
                        updatedMessages.splice(0, updatedMessages.length - 100);
                    }

                    Storage.set('chat:messages', JSON.stringify(updatedMessages));
                    
                    setMessages(updatedMessages);
                    setInputMessage('');
                    
                } catch (error) {
                    console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
                    alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    setSendingMessage(false);
                }
            };

            const formatTime = (timestamp) => {
                try {
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString('ko-KR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                } catch (error) {
                    return '';
                }
            };

            const handleLogout = () => {
                Storage.delete(`online:${username}`);
                onLogout();
            };

            return (
                <div className="fade-in" style={{
                    display: 'flex',
                    gap: '20px',
                    height: '650px'
                }}>
                    {/* ì‚¬ì´ë“œë°” */}
                    <div style={{
                        width: '280px',
                        background: 'white',
                        borderRadius: '20px',
                        padding: '28px',
                        boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
                        display: 'flex',
                        flexDirection: 'column',
                        border: '1px solid #e8e8e8'
                    }}>
                        <div style={{
                            marginBottom: '28px',
                            paddingBottom: '28px',
                            borderBottom: '2px solid #f0f0f0'
                        }}>
                            <div style={{
                                fontSize: '18px',
                                fontWeight: '700',
                                color: '#1a1a2e',
                                marginBottom: '14px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                <div style={{
                                    width: '12px',
                                    height: '12px',
                                    borderRadius: '50%',
                                    background: '#10b981',
                                    boxShadow: '0 0 0 3px rgba(16, 185, 129, 0.2)'
                                }}></div>
                                {username}
                            </div>
                            <button
                                onClick={handleLogout}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    background: '#f7fafc',
                                    color: '#4a5568',
                                    border: '1px solid #e2e8f0',
                                    borderRadius: '10px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    transition: 'all 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                    e.target.style.background = '#edf2f7';
                                    e.target.style.borderColor = '#cbd5e0';
                                }}
                                onMouseLeave={(e) => {
                                    e.target.style.background = '#f7fafc';
                                    e.target.style.borderColor = '#e2e8f0';
                                }}
                            >
                                ë¡œê·¸ì•„ì›ƒ
                            </button>
                        </div>

                        <div>
                            <div style={{
                                fontSize: '15px',
                                fontWeight: '700',
                                marginBottom: '18px',
                                color: '#2d3748',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}>
                                <div style={{
                                    width: '10px',
                                    height: '10px',
                                    borderRadius: '50%',
                                    background: '#10b981'
                                }}></div>
                                ì˜¨ë¼ì¸ ({onlineUsers.size})
                            </div>
                            <div style={{
                                maxHeight: '450px',
                                overflowY: 'auto'
                            }}>
                                {Array.from(onlineUsers).sort().map(user => (
                                    <div
                                        key={user}
                                        style={{
                                            padding: '12px 14px',
                                            background: user === username ? '#f0f9ff' : '#f9fafb',
                                            borderRadius: '10px',
                                            marginBottom: '10px',
                                            fontSize: '14px',
                                            color: '#1a1a2e',
                                            fontWeight: user === username ? '600' : '400',
                                            border: '1px solid ' + (user === username ? '#bae6fd' : '#f3f4f6'),
                                            transition: 'all 0.2s'
                                        }}
                                    >
                                        {user === username ? `${user} (ë‚˜)` : user}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* ì±„íŒ… ì˜ì—­ */}
                    <div style={{
                        flex: 1,
                        background: 'white',
                        borderRadius: '20px',
                        boxShadow: '0 10px 40px rgba(0,0,0,0.1)',
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden',
                        border: '1px solid #e8e8e8'
                    }}>
                        {/* í—¤ë” */}
                        <div style={{
                            padding: '24px 28px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            color: 'white',
                            fontSize: '20px',
                            fontWeight: '700',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            boxShadow: '0 2px 10px rgba(102, 126, 234, 0.3)'
                        }}>
                            ğŸ’¬ ì „ì²´ ì±„íŒ…ë°©
                            <div style={{
                                marginLeft: 'auto',
                                fontSize: '13px',
                                fontWeight: '500',
                                opacity: 0.9
                            }}>
                                {onlineUsers.size}ëª… ì ‘ì†ì¤‘
                            </div>
                        </div>

                        {/* ë©”ì‹œì§€ ëª©ë¡ */}
                        <div style={{
                            flex: 1,
                            overflowY: 'auto',
                            padding: '28px',
                            background: '#fafafa'
                        }}>
                            {messages.length === 0 ? (
                                <div style={{
                                    textAlign: 'center',
                                    color: '#a0aec0',
                                    marginTop: '80px',
                                    fontSize: '15px'
                                }}>
                                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ’­</div>
                                    ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì„œ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”
                                </div>
                            ) : (
                                messages.map((msg) => (
                                    <div
                                        key={msg.id}
                                        style={{
                                            marginBottom: '18px',
                                            display: 'flex',
                                            justifyContent: msg.username === username ? 'flex-end' : 'flex-start'
                                        }}
                                    >
                                        <div style={{
                                            maxWidth: '65%'
                                        }}>
                                            {msg.username !== username && (
                                                <div style={{
                                                    fontSize: '13px',
                                                    color: '#667eea',
                                                    fontWeight: '700',
                                                    marginBottom: '6px',
                                                    marginLeft: '6px'
                                                }}>
                                                    {msg.username}
                                                </div>
                                            )}
                                            <div style={{
                                                background: msg.username === username 
                                                    ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' 
                                                    : 'white',
                                                color: msg.username === username ? 'white' : '#1a1a2e',
                                                padding: '14px 18px',
                                                borderRadius: '14px',
                                                boxShadow: msg.username === username 
                                                    ? '0 4px 12px rgba(102, 126, 234, 0.3)' 
                                                    : '0 2px 8px rgba(0,0,0,0.08)',
                                                wordWrap: 'break-word',
                                                border: msg.username === username ? 'none' : '1px solid #e8e8e8',
                                                lineHeight: '1.5'
                                            }} dangerouslySetInnerHTML={{ __html: msg.text }}>
                                            </div>
                                            {msg.isFiltered && (
                                                <div style={{
                                                    fontSize: '11px',
                                                    marginTop: '6px',
                                                    marginLeft: '6px',
                                                    color: '#f59e0b',
                                                    fontWeight: '500'
                                                }}>
                                                    âš ï¸ ë¶€ì ì ˆí•œ ì–¸ì–´ê°€ í•„í„°ë§ë˜ì—ˆìŠµë‹ˆë‹¤
                                                </div>
                                            )}
                                            <div style={{
                                                fontSize: '11px',
                                                color: '#a0aec0',
                                                marginTop: '5px',
                                                marginLeft: '6px',
                                                textAlign: msg.username === username ? 'right' : 'left'
                                            }}>
                                                {formatTime(msg.timestamp)}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* ì…ë ¥ í¼ */}
                        <form
                            onSubmit={sendMessage}
                            style={{
                                padding: '24px 28px',
                                borderTop: '2px solid #f0f0f0',
                                display: 'flex',
                                gap: '14px',
                                background: 'white'
                            }}
                        >
                            <input
                                type="text"
                                value={inputMessage}
                                onChange={(e) => setInputMessage(e.target.value)}
                                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ìµœëŒ€ 500ì)"
                                disabled={sendingMessage}
                                maxLength={500}
                                style={{
                                    flex: 1,
                                    padding: '14px 18px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '14px',
                                    fontSize: '15px',
                                    outline: 'none',
                                    transition: 'all 0.2s',
                                    background: sendingMessage ? '#f5f5f5' : 'white'
                                }}
                                onFocus={(e) => e.target.style.borderColor = '#667eea'}
                                onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                            />
                            <button
                                type="submit"
                                disabled={sendingMessage || !inputMessage.trim()}
                                style={{
                                    padding: '14px 32px',
                                    background: (sendingMessage || !inputMessage.trim()) 
                                        ? '#cbd5e0' 
                                        : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '14px',
                                    fontSize: '15px',
                                    fontWeight: '700',
                                    cursor: (sendingMessage || !inputMessage.trim()) ? 'not-allowed' : 'pointer',
                                    transition: 'all 0.2s',
                                    boxShadow: (sendingMessage || !inputMessage.trim()) 
                                        ? 'none' 
                                        : '0 4px 15px rgba(102, 126, 234, 0.4)'
                                }}
                                onMouseEnter={(e) => {
                                    if (!sendingMessage && inputMessage.trim()) {
                                        e.target.style.transform = 'scale(1.05)';
                                    }
                                }}
                                onMouseLeave={(e) => {
                                    e.target.style.transform = 'scale(1)';
                                }}
                            >
                                {sendingMessage ? 'ì „ì†¡ì¤‘...' : 'ì „ì†¡'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // ==================== ë©”ì¸ ì•± ====================
        
        function App() {
            const [currentUser, setCurrentUser] = useState(null);

            const handleLogin = (username) => {
                setCurrentUser(username);
            };

            const handleLogout = () => {
                setCurrentUser(null);
            };

            return (
                <div>
                    {!currentUser ? (
                        <AuthScreen onLogin={handleLogin} />
                    ) : (
                        <ChatScreen username={currentUser} onLogout={handleLogout} />
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
